<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kraujo tyrimÅ³ analizÄ— (beta)</title>
  <meta name="description" content="Ä®kelkite kraujo tyrimÅ³ nuotraukas arba PDF. OCR vyksta tik narÅ¡yklÄ—je.">
  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">
  <style>
    .dropzone { border: 2px dashed rgba(0,0,0,0.2); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF -> canvas -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <div class="max-w-5xl mx-auto p-4 sm:p-8">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-semibold">Kraujo tyrimÅ³ analizÄ— (beta)</h1>
      <p class="text-sm text-gray-600 mt-2">
        Ä®kelkite laboratoriniÅ³ tyrimÅ³ <b>nuotraukas arba PDF</b> (pvz., CBC, biochemija). Apdorojimas vyksta tik JÅ«sÅ³ Ä¯renginyje.
      </p>
    </header>

    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 text-sm rounded-lg p-3 mb-6">
      <b>Svarbu:</b> tai <u>ne</u> medicininÄ— diagnozÄ— ir <u>ne</u> gydymo rekomendacija. DÄ—l rezultatÅ³ interpretacijos <b>kreipkitÄ—s Ä¯ gydytojÄ…</b>.
    </div>

    <!-- Ä®kÄ—limas -->
    <section class="mb-6">
      <div id="drop" class="dropzone rounded-xl p-6 bg-white text-center cursor-pointer">
        <p class="text-sm text-gray-600">Nutempkite failus Äia arba paspauskite, kad pasirinktumÄ—te.</p>
        <p class="text-xs text-gray-400 mt-1">LeidÅ¾iami: JPG, PNG, WEBP, HEIC (jei palaiko), PDF.</p>
        <input id="fileInput" type="file" accept="image/*,application/pdf" multiple class="hidden">
      </div>

      <div class="mt-4 flex items-center gap-3">
        <button id="startBtn" class="px-4 py-2 rounded-lg bg-black text-white disabled:opacity-40">Analizuoti</button>
        <span id="status" class="text-sm text-gray-600"></span>
      </div>

      <details class="mt-4">
        <summary class="text-sm font-medium cursor-pointer">IÅ¡plÄ—stiniai nustatymai</summary>
        <div class="mt-3 space-y-2 text-sm">
          <label class="flex items-center gap-2">
            <input id="langLt" type="checkbox" checked>
            <span>Naudoti lietuviÅ³ kalbos modelÄ¯ (jei prieinamas)</span>
          </label>
          <label class="flex items-center gap-2">
            <input id="aggressive" type="checkbox">
            <span>Agresyvesnis lenteliÅ³/diag. iÅ¡gavimas</span>
          </label>
        </div>
      </details>
    </section>

    <!-- KreÅ¡umo Ä¯spÄ—jimas -->
    <section id="coagWrap" class="hidden mb-6">
      <div class="border border-red-200 bg-red-50 text-red-900 rounded-xl p-4">
        <h3 class="font-semibold">DÄ–MESIO: galimi nukrypimai kraujo kreÅ¡umo tyrimuose</h3>
        <p class="text-sm mt-1">
          Kraujo tyrimas <b>neatitinka normÅ³</b>. Rekomenduojame <b>pakartoti tyrimus po keliÅ³ dienÅ³</b> ir, jei planuojama operacija,
          <b>susisiekti dÄ—l galimo operacijos perkÄ—limo</b>.
        </p>
        <div class="overflow-x-auto bg-white rounded-lg border mt-3">
          <table class="min-w-full text-sm">
            <thead class="bg-red-100">
              <tr>
                <th class="text-left px-3 py-2">Tyrimas</th>
                <th class="text-left px-3 py-2">ReikÅ¡mÄ—</th>
                <th class="text-left px-3 py-2">Vienetai</th>
                <th class="text-left px-3 py-2">Norma</th>
                <th class="text-left px-3 py-2">Å½yma</th>
              </tr>
            </thead>
            <tbody id="coagTbody"></tbody>
          </table>
        </div>
        <p class="text-xs mt-2 opacity-80">Informacinis perspÄ—jimas â€“ nepakeiÄia gydytojo sprendimÅ³.</p>
      </div>
    </section>

    <!-- SuvestinÄ— -->
    <section id="results" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">SuvestinÄ—</h2>
        <div class="flex gap-2">
          <button id="exportCsv" class="text-sm px-3 py-1.5 rounded border">AtsisiÅ³sti CSV</button>
          <button id="clearBtn" class="text-sm px-3 py-1.5 rounded border">IÅ¡valyti</button>
        </div>
      </div>

      <div class="overflow-x-auto bg-white rounded-xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left px-3 py-2">Tyrimas</th>
              <th class="text-left px-3 py-2">ReikÅ¡mÄ—</th>
              <th class="text-left px-3 py-2">Vienetai</th>
              <th class="text-left px-3 py-2">Norma (pagauta)</th>
              <th class="text-left px-3 py-2">Å½yma</th>
              <th class="text-left px-3 py-2">Trumpa pastaba</th>
              <th class="text-left px-3 py-2">Å altinis eilutÄ—je</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <details class="mt-4">
        <summary class="text-sm font-medium cursor-pointer">Å½alias atpaÅ¾intas tekstas</summary>
        <pre id="raw" class="mono text-xs bg-gray-900 text-gray-100 rounded-lg p-3 overflow-x-auto"></pre>
      </details>

      <p class="text-xs text-gray-500 mt-3">
        Pirmumas â€“ laboratorijos dokumente nurodytoms riboms. Jei jÅ³ nÄ—ra, taikomos atsargios â€tipinÄ—sâ€œ ribos (paÅ¾ymimos).
      </p>
    </section>

    <footer class="mt-12 text-xs text-gray-400">
      Â© <span id="yr"></span>. Informacinis Ä¯rankis. Ne medicininÄ— konsultacija.
    </footer>
  </div>

<script>
/* === PagalbinÄ—s === */
const $ = (id) => document.getElementById(id);
$("yr").textContent = new Date().getFullYear();

const DEC = (s) => { if (s==null) return null; const x=(""+s).replace(/\s/g,"").replace(",","."); const n=Number(x); return Number.isFinite(n)?n:null; };
const HL_RX    = /\b([HL])\b/;
const RANGE_RX = /(\d+(?:[.,]\d+)?)\s*[-â€“â€”]\s*(\d+(?:[.,]\d+)?)/;

/* Vienetai + normalizacija */
const UNIT_RX = /(g\/L|g\/dL|g%|mmol\/L|mg\/dL|Âµg\/L|ng\/mL|mIU\/L|ÂµIU\/mL|pmol\/L|ng\/dL|x?10\^9\/L|10\^9\/L|x?10\^12\/L|10\^12\/L|10\^3\/u?L|10\^9\/u?L|\/ÂµL|\/uL|\/Âµl|\/ul|\/mm3|\/cu\.mm|mg\/L|%|s|sec|sek|min|fL|fl|pg)/i;
function normalizeUnits(u){
  if(!u) return u;
  u = u.replace(/\s+/g,"");
  if(/^g%$/i.test(u)) return "g/dL";
  if(/^\/cu\.mm$/i.test(u)) return "/mm3";
  if(/^\/u?l$/i.test(u)) return "/ÂµL";
  if(/^10\^3\/u?l$/i.test(u)) return "10^3/ÂµL";
  return u;
}

/* Pastabos (neutralios) */
const NOTES = {
  "Hemoglobinas": {low:"DaÅ¾na prieÅ¾astis â€“ geleÅ¾ies stoka ar kraujavimas. Pasitarkite su gydytoju.", high:"Gali bÅ«ti dehidratacija ar kitos bÅ«klÄ—s; vertinti klinikÄ…."},
  "Feritinas": {low:"DaÅ¾nai rodo geleÅ¾ies trÅ«kumÄ…; vertinti su Hb/MCV/CRP.", high:"Gali kilti uÅ¾degimo metu; vertinti su CRP."},
  "CRP": {high:"PadidÄ—jimas daÅ¾niausiai siejamas su uÅ¾degimu."},
  "TSH": {low:"Galima hiperfunkcija; vertinti su FT4/FT3.", high:"Galima hipotirozÄ—; vertinti su FT4/FT3."},
  "GliukozÄ—": {high:"Gali rodyti angliavandeniÅ³ apykaitos sutrikimus; vertinti pakartotinai."},
  "Vit D": {low:"DaÅ¾nas trÅ«kumas; korekcijÄ… aptaria gydytojas."},
  // KreÅ¡umas
  "INR": {high:"PadidÄ—jÄ™s INR â€“ ilgesnis kreÅ¡Ä—jimo laikas.", low:"MaÅ¾as INR â€“ trumpesnis kreÅ¡Ä—jimo laikas."},
  "Protrombino laikas (PT)": {high:"PrailgÄ—jÄ™s PT â€“ lÄ—tesnis kreÅ¡Ä—jimas.", low:"SutrumpÄ—jÄ™s PT â€“ greitesnis kreÅ¡Ä—jimas."},
  "aPTT": {high:"PrailgÄ—jÄ™s aPTT â€“ lÄ—tesnis kreÅ¡Ä—jimas.", low:"SutrumpÄ—jÄ™s aPTT â€“ greitesnis kreÅ¡Ä—jimas."},
  "Fibrinogenas": {low:"Å½emas fibrinogenas gali maÅ¾inti kreÅ¡umÄ….", high:"Didelis fibrinogenas daÅ¾nai susijÄ™s su uÅ¾degimu."},
  "D-dimerai": {high:"PadidÄ—jÄ™ D-dimerai bÅ«na Ä¯vairiose bÅ«klÄ—se; vertinti kliniÅ¡kai."}
};

/* Daug iÅ¡plÄ—stÅ³ sinonimÅ³ */
const TEST_MAP = [
  // CBC baziniai
  {rx:/\b(HGB|Hb|ha?emoglobi?n[eai]?s?)\b/i, name:"Hemoglobinas"}, // Hemoglobin/Haemoglobin/Hb
  {rx:/\b(HCT|hematokrit(as)?|PCV)\b/i, name:"Hematokritas"},      // HCT/PCV
  {rx:/\b(RBC(\s*Count)?|erythrocyt(es?|e)?|eritrocit(ai|Å³)?)\b/i, name:"Eritrocitai"},
  {rx:/\b((Total\s*)?WBC(\s*Count)?|leukocyt(es?|e)?|leukocit(ai|Å³)?)\b/i, name:"Leukocitai"},
  {rx:/\b(PLT|Platelet(\s*Count)?|trombocit(ai|Å³)?)\b/i, name:"Trombocitai"},
  // EritrocitÅ³ indeksai
  {rx:/\bMCV\b/i, name:"MCV"},
  {rx:/\bMCH\b/i, name:"MCH"},
  {rx:/\bMCHC\b/i, name:"MCHC"},
  {rx:/\bRDW(-CV)?\b/i, name:"RDW-CV"},
  {rx:/\bRDW-?SD\b/i, name:"RDW-SD"},
  // LeukocitÅ³ diferencialas (rodysim, jei atpaÅ¾ins â€“ be ribÅ³)
  {rx:/\bNEU[%#]?\b|\bNeutrophils?\b/i, name:"Neutrofilai"},
  {rx:/\bLYM[%#]?\b|\bLymphocytes?\b/i, name:"Limfocitai"},
  {rx:/\bMON[%#]?\b|\bMonocytes?\b/i, name:"Monocitai"},
  {rx:/\bEOS[%#]?\b|\bEosinophils?\b/i, name:"Eozinofilai"},
  {rx:/\bBAS[%#]?\b|\bBasophils?\b/i, name:"Bazofilai"},
  // Biochemija / kiti
  {rx:/\b(glucose|gliukoz[Ä—e]|Glu)\b/i, name:"GliukozÄ—"},
  {rx:/\bCRP\b/i, name:"CRP"},
  {rx:/\bferritin(as)?\b/i, name:"Feritinas"},
  {rx:/\b(total\s*chol|cholesterol(is)?|chol\b)\b/i, name:"Cholesterolis"},
  {rx:/\bHDL\b/i, name:"HDL"},
  {rx:/\bLDL\b/i, name:"LDL"},
  {rx:/\btriglycerid(es)?|triglicerid(ai|Å³)|\bTG\b/i, name:"Trigliceridai"},
  {rx:/\bTSH\b/i, name:"TSH"},
  {rx:/\bFT4\b/i, name:"FT4"},
  {rx:/\bVit(\.?|aminas\s*)D\b/i, name:"Vit D"},
  // KreÅ¡umas
  {rx:/\bINR\b/i, name:"INR"},
  {rx:/\b(PT|protrombin(o)?\s*laik(as)?|Quick)\b/i, name:"Protrombino laikas (PT)"},
  {rx:/\bA?PTT\b|\baktyvuotas?\s+dalinis\s+tromboplastino\s+laikas\b/i, name:"aPTT"},
  {rx:/\bfibrinogen(as)?\b/i, name:"Fibrinogenas"},
  {rx:/\bD[\s-]?dimer(ai|Å³)?\b/i, name:"D-dimerai"},
];

/* TipinÄ—s (atsargios) ribos â€“ pirmenybÄ— laboratorijos riboms */
const TYPICAL = {
  "Hemoglobinas":   { units:["g/dL","g/L"], ranges:[{u:"g/dL", lo:12, hi:16},{u:"g/L", lo:120, hi:160}] },
  "Hematokritas":   { units:["%"], ranges:[{u:"%", lo:36, hi:46}] },
  "Eritrocitai":    { units:["x10^12/L","10^12/L"], ranges:[{u:"x10^12/L", lo:3.8, hi:5.2},{u:"10^12/L", lo:3.8, hi:5.2}] },
  "Leukocitai":     { units:["x10^9/L","10^9/L","/ÂµL","/mm3","10^3/ÂµL"], ranges:[
    {u:"x10^9/L", lo:4.0, hi:10.0},{u:"10^9/L", lo:4.0, hi:10.0},
    {u:"/ÂµL", lo:4000, hi:11000},{u:"/mm3", lo:4000, hi:11000},
    {u:"10^3/ÂµL", lo:4.0, hi:11.0}
  ]},
  "Trombocitai":    { units:["x10^9/L","10^9/L","/ÂµL","/mm3","10^3/ÂµL"], ranges:[
    {u:"x10^9/L", lo:150, hi:400},{u:"10^9/L", lo:150, hi:400},
    {u:"/ÂµL", lo:150000, hi:450000},{u:"/mm3", lo:150000, hi:450000},
    {u:"10^3/ÂµL", lo:150, hi:450}
  ]},
  "CRP":            { units:["mg/L"], ranges:[{u:"mg/L", lo:0, hi:5}] },
  "Feritinas":      { units:["Âµg/L","ng/mL"], ranges:[{u:"Âµg/L", lo:15, hi:150},{u:"ng/mL", lo:15, hi:150}] },
  "GliukozÄ—":       { units:["mmol/L","mg/dL"], ranges:[{u:"mmol/L", lo:3.9, hi:5.5},{u:"mg/dL", lo:70, hi:99}] },
  "Cholesterolis":  { units:["mmol/L","mg/dL"], ranges:[{u:"mmol/L", lo:0, hi:5.0},{u:"mg/dL", lo:0, hi:200}] },
  "HDL":            { units:["mmol/L","mg/dL"], ranges:[{u:"mmol/L", lo:1.0, hi:2.5},{u:"mg/dL", lo:40, hi:97}] },
  "LDL":            { units:["mmol/L","mg/dL"], ranges:[{u:"mmol/L", lo:0, hi:3.0},{u:"mg/dL", lo:0, hi:116}] },
  "Trigliceridai":  { units:["mmol/L","mg/dL"], ranges:[{u:"mmol/L", lo:0, hi:1.7},{u:"mg/dL", lo:0, hi:150}] },
  "TSH":            { units:["mIU/L","ÂµIU/mL"], ranges:[{u:"mIU/L", lo:0.4, hi:4.0},{u:"ÂµIU/mL", lo:0.4, hi:4.0}] },
  "FT4":            { units:["pmol/L","ng/dL"], ranges:[{u:"pmol/L", lo:12, hi:22},{u:"ng/dL", lo:0.9, hi:1.7}] },
  "Vit D":          { units:["ng/mL","nmol/L"], ranges:[{u:"ng/mL", lo:20, hi:50},{u:"nmol/L", lo:50, hi:125}] },
  "MCV":            { units:["fL","fl"], ranges:[{u:"fL", lo:80, hi:99},{u:"fl", lo:80, hi:99}] },
  "MCH":            { units:["pg"],      ranges:[{u:"pg", lo:28, hi:32}] },
  "MCHC":           { units:["g/dL"],    ranges:[{u:"g/dL", lo:30, hi:34}] },
  // KreÅ¡umas
  "INR":            { units:["","vnt"], ranges:[{u:"", lo:0.8, hi:1.2},{u:"vnt", lo:0.8, hi:1.2}] },
  "Protrombino laikas (PT)": { units:["s","sek","sec"], ranges:[{u:"s", lo:11, hi:15},{u:"sek", lo:11, hi:15},{u:"sec", lo:11, hi:15}] },
  "aPTT":           { units:["s","sek","sec"], ranges:[{u:"s", lo:25, hi:35},{u:"sek", lo:25, hi:35},{u:"sec", lo:25, hi:35}] },
  "Fibrinogenas":   { units:["g/L"], ranges:[{u:"g/L", lo:2.0, hi:4.0}] },
  "D-dimerai":      { units:["mg/L","mg/L FEU","Âµg/mL","Âµg/mL FEU"], ranges:[
    {u:"mg/L", lo:0, hi:0.5},{u:"mg/L FEU", lo:0, hi:0.5},{u:"Âµg/mL", lo:0, hi:0.5},{u:"Âµg/mL FEU", lo:0, hi:0.5}
  ]},
};

/* UI ir failai */
const drop = $("drop"), input=$("fileInput"), startBtn=$("startBtn"), statusEl=$("status");
const results = $("results"), tbody=$("tbody"), raw=$("raw"), exportCsv=$("exportCsv"), clearBtn=$("clearBtn");
const coagWrap = $("coagWrap"), coagTbody = $("coagTbody");
let files=[];

drop.addEventListener("click", () => input.click());
drop.addEventListener("dragover", (e)=>{e.preventDefault(); drop.classList.add("bg-gray-100");});
drop.addEventListener("dragleave", ()=>drop.classList.remove("bg-gray-100"));
drop.addEventListener("drop",(e)=>{
  e.preventDefault(); drop.classList.remove("bg-gray-100");
  files=[...e.dataTransfer.files].filter(f=> f.type.startsWith("image/") || f.type==="application/pdf");
  statusEl.textContent=files.length?`Pasirinkta ${files.length} failas(-ai).`:"Nepasirinkta jokiÅ³ failÅ³.";
});
input.addEventListener("change",(e)=>{
  files=[...e.target.files];
  statusEl.textContent=files.length?`Pasirinkta ${files.length} failas(-ai).`:"Nepasirinkta jokiÅ³ failÅ³.";
});

/* Vaizdo pagerinimas prieÅ¡ OCR (binarizacija) */
async function fileToEnhancedBlob(file) {
  const img = await new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = () => resolve(im);
    im.onerror = reject;
    im.src = url;
  });
  const maxW = 2000;
  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);

  const imgData = ctx.getImageData(0, 0, w, h), d = imgData.data;
  let sum=0; for (let i=0;i<d.length;i+=4){ const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; sum+=g; }
  const avg = sum/(d.length/4), T = Math.max(110, Math.min(170, avg));
  for (let i=0;i<d.length;i+=4){ const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; const v=(g>T)?255:0; d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; }
  ctx.putImageData(imgData,0,0);
  const blob = await new Promise(res => c.toBlob(res, "image/png", 1));
  URL.revokeObjectURL(img.src); return blob;
}

/* PDF -> paveikslÅ³ sÄ…raÅ¡as */
async function pdfToImageBlobs(file, scale = 2.0) {
  const arrayBuf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
  const blobs = [];
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width; canvas.height = viewport.height;
    const ctx = canvas.getContext("2d");
    await page.render({ canvasContext: ctx, viewport }).promise;
    const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1));
    blobs.push(blob);
  }
  return blobs;
}

/* IÅ¡ Å¾odÅ¾iÅ³ (bbox) sudedame eilutes */
function groupWordsIntoLinesLoose(words){
  if (!words || !words.length) return [];
  const good = words.filter(w => (w.text||"").trim()); // be conf filtro
  good.sort((a,b)=> a.y0 - b.y0 || a.x0 - b.x0);
  const lines = [], TOL = 16; // platesnÄ— tolerancija
  for(const w of good){
    let line = lines.find(L => Math.abs(L.y - w.y0) < TOL);
    if(!line){ line = { y: w.y0, words: [] }; lines.push(line); }
    line.words.push(w);
  }
  for(const L of lines){ L.words.sort((a,b)=> a.x0 - b.x0); L.text = L.words.map(w=>w.text).join(" "); }
  return lines.map(L => L.text).filter(s=>s.trim());
}

/* Pagrindinis veiksmas */
startBtn.addEventListener("click", async () => {
  if (!files.length){ statusEl.textContent="Ä®kelkite bent vienÄ… failÄ…."; return; }
  startBtn.disabled=true;
  tbody.innerHTML=""; raw.textContent=""; coagTbody.innerHTML=""; coagWrap.classList.add("hidden");
  results.classList.remove("hidden"); statusEl.textContent="Vyksta OCRâ€¦";
  const useLt=$("langLt").checked, aggressive=$("aggressive").checked;

  try{
const worker = await Tesseract.createWorker(useLt ? "lit+eng" : "eng", 1, {});
await worker.setParameters({
  tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.%/^-â€“â€”()ÂµgdlpmnIUFLcu ",
  preserve_interword_spaces: "1",
  user_defined_dpi: "300",
  tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
  tessedit_do_invert: "1"          // ğŸ‘ˆ pridÄ—ta eilutÄ— (padeda â€iÅ¡balintiemsâ€œ skenams)
});

    let allText = "", allWords = [];

    for (let i = 0; i < files.length; i++) {
      statusEl.textContent = `OCR ${i+1}/${files.length}â€¦`;
      const f = files[i];
      let blobs = [];
      if (f.type === "application/pdf") {
        const pageBlobs = await pdfToImageBlobs(f, 2.0);
        for (const b of pageBlobs) {
          const fakeFile = new File([b], "page.png", { type: "image/png" });
          blobs.push(await fileToEnhancedBlob(fakeFile));
        }
      } else {
        blobs.push(await fileToEnhancedBlob(f));
      }

      for (let j = 0; j < blobs.length; j++) {
        const label = blobs.length > 1 ? ` (psl. ${j+1})` : "";
        const { data } = await worker.recognize(blobs[j]);
        allText += `\n\n===== FAILAS ${i+1}${label} =====\n` + data.text;
        allWords = allWords.concat(data.words.map(w => ({
          text: w.text, x0:w.bbox.x0, y0:w.bbox.y0, x1:w.bbox.x1, y1:w.bbox.y1, conf:w.conf
        })));
      }
    }
    await worker.terminate();

    raw.textContent = allText.trim();
    statusEl.textContent="Analizuoju tekstÄ…â€¦";

    let linesFromBBoxes = groupWordsIntoLines(allWords);

// Fallback #1: jei per maÅ¾ai eiluÄiÅ³ iÅ¡ bbox, bandome â€Å¡velnesnÄ¯â€œ grupavimÄ…
if (!linesFromBBoxes || linesFromBBoxes.length < 5) {
  linesFromBBoxes = groupWordsIntoLinesLoose(allWords);
}

// Fallback #2: jei vis dar nieko â€” krentame Ä¯ â€raw textâ€œ eilutes
let rows = analyzeLines(linesFromBBoxes,{aggressive});
if (!rows.length) {
  const naiveLines = raw.textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  rows = analyzeLines(naiveLines,{aggressive:true}); // agresyvesnis reÅ¾imas
}

renderRows(rows);
renderCoagAlert(rows);
statusEl.textContent = rows.length ? `Rasta Ä¯raÅ¡Å³: ${rows.length}` : "Nepavyko aptikti lentelÄ—s. Pabandykite aiÅ¡kesnÄ™ nuotraukÄ…/PDF arba priartinkite tik lentelÄ™.";

  }catch(err){
    console.error(err);
    statusEl.textContent="Ä®vyko klaida apdorojant. PamÄ—ginkite dar kartÄ….";
  }finally{
    startBtn.disabled=false;
  }
});

function analyzeLines(lines,{aggressive=false}={}){ return analyzeText(lines.join("\n"),{aggressive}); }

/* Parsinimas (ieÅ¡ko reikÅ¡mÄ—s ir gretimose eilutÄ—se) */
function analyzeText(text,{aggressive=false}={}){
  const lines = text.split(/\r?\n/).map(s=>s.replace(/\t+/g,' ').replace(/\s{2,}/g,' ').trim()).filter(Boolean);
  const results=[], windowSize=2;
  for(let i=0;i<lines.length;i++){
    const line=lines[i];
    const hit = TEST_MAP.find(m=>m.rx.test(line));
    if(!hit){ if(!aggressive) continue; if(!/[A-Za-zÄ„ÄŒÄ˜Ä–Ä®Å Å²ÅªÄ…ÄÄ™Ä—Ä¯Å¡Å³Å«]/.test(line)) continue; }
    const name = hit ? hit.name : (line.split(/[:\-]/)[0]||"NeatpaÅ¾intas").trim();

    let value=null, units=null, flag=null;
    const hl=line.match(HL_RX); if(hl) flag=hl[1].toUpperCase()==="H"?"H":"L";

    // ReikÅ¡mÄ— Å¡ioje arba sekanÄiose 1â€“2 eilutÄ—se
    let m = line.match(/(-?\d+(?:[.,]\d+)?)/);
    if (m) value = DEC(m[1]);
    if (value==null) {
      for (let k=1; k<=2 && i+k<lines.length; k++){
        const cand = lines[i+k];
        const mm = cand.match(/(-?\d+(?:[.,]\d+)?)/);
        if (mm) { value = DEC(mm[1]); const um2 = cand.match(UNIT_RX); if (um2) units = normalizeUnits(um2[1]); break; }
      }
    }

    // Vienetai
    const um=line.match(UNIT_RX); if(um) units=normalizeUnits(um[1]);

    // Ribos â€“ Å¡i/greta
    let lo=null, hi=null, rangeText=null, r=line.match(RANGE_RX);
    if(!r){
      for(let k=1;k<=windowSize && i+k<lines.length;k++){ r=lines[i+k].match(RANGE_RX); if(r) break; }
      if(!r){ for(let k=1;k<=windowSize && i-k>=0;k++){ r=lines[i-k].match(RANGE_RX); if(r) break; } }
    }
    if(r){ lo=DEC(r[1]); hi=DEC(r[2]); rangeText=`${r[1]}â€“${r[2]}`; }

    // TipinÄ—s ribos â€“ jei laboratorija nenurodÄ—
    let usedTypical=false;
    if((lo==null || hi==null) && name in TYPICAL){
      const t=TYPICAL[name];
      if(units && t.units.some(u=>u.toLowerCase()===units.toLowerCase())){
        const rr=t.ranges.find(x=>x.u.toLowerCase()===units.toLowerCase());
        if(rr){ lo=rr.lo; hi=rr.hi; usedTypical=true; rangeText=`${rr.lo}â€“${rr.hi}`; }
      } else if(!units && t.ranges.length){
        lo=t.ranges[0].lo; hi=t.ranges[0].hi; units=t.ranges[0].u; usedTypical=true; rangeText=`${lo}â€“${hi}`;
      }
    }

    let tag="";
    if(value!=null && lo!=null && hi!=null){ tag = value<lo ? "Å½emas" : (value>hi ? "AukÅ¡tas" : "Normoje"); }
    else if(flag){ tag = flag==="H" ? "AukÅ¡tas" : "Å½emas"; }
    else { tag="NeaiÅ¡ku"; }

    let note=""; if(name in NOTES){ if(tag==="AukÅ¡tas" && NOTES[name].high) note=NOTES[name].high; if(tag==="Å½emas" && NOTES[name].low) note=NOTES[name].low; }
    if(!value && !aggressive) continue;

    results.push({name, value, units:units||"", range:rangeText||"", lo, hi, tag, note, typicalFallback:usedTypical, source:line});
  }

  // sujungiam dublikatus
  const merged=new Map();
  for(const r of results){
    const key=r.name+"|"+(r.units||"");
    if(!merged.has(key)) merged.set(key,r);
    else{
      const score=x=> (x.lo!=null && x.hi!=null ? 2:0) + (x.value!=null?1:0);
      merged.set(key, score(r)>=score(merged.get(key)) ? r : merged.get(key));
    }
  }
  return [...merged.values()];
}

/* Atvaizdavimas */
function renderRows(rows){
  const tbody = $("tbody");
  tbody.innerHTML="";
  for(const r of rows){
    const color = r.tag==="AukÅ¡tas"?"bg-red-50 text-red-700" : r.tag==="Å½emas"?"bg-yellow-50 text-yellow-700" : r.tag==="Normoje"?"bg-green-50 text-green-700":"bg-gray-50 text-gray-700";
    const tip = r.typicalFallback ? ' <span class="text-xs text-gray-500">(tipinÄ—s ribos)</span>' : '';
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="px-3 py-2">${escapeHtml(r.name)}</td>
      <td class="px-3 py-2">${r.value!=null ? r.value : ""}</td>
      <td class="px-3 py-2">${escapeHtml(r.units||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.range||"")}${tip}</td>
      <td class="px-3 py-2"><span class="px-2 py-1 rounded ${color}">${r.tag}</span></td>
      <td class="px-3 py-2">${escapeHtml(r.note||"")}</td>
      <td class="px-3 py-2 text-xs text-gray-500">${escapeHtml(r.source)}</td>
    `;
    tbody.appendChild(tr);
  }
}

function isCoagTest(name){
  return ["INR","Protrombino laikas (PT)","aPTT","Fibrinogenas","D-dimerai"].includes(name);
}

function renderCoagAlert(rows){
  const bad = rows.filter(r => isCoagTest(r.name) && (r.tag==="AukÅ¡tas" || r.tag==="Å½emas"));
  if(!bad.length){ coagWrap.classList.add("hidden"); return; }
  coagTbody.innerHTML="";
  for(const r of bad){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="px-3 py-2">${escapeHtml(r.name)}</td>
      <td class="px-3 py-2">${r.value!=null ? r.value : ""}</td>
      <td class="px-3 py-2">${escapeHtml(r.units||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.range||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.tag)}</td>
    `;
    coagTbody.appendChild(tr);
  }
  coagWrap.classList.remove("hidden");
}

function escapeHtml(s){
  return (s==null?"":String(s))
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* Eksportas / valdymas */
exportCsv.addEventListener("click", ()=>{
  const rows=[...$("tbody").querySelectorAll("tr")].map(tr=>[...tr.children].map(td=>td.textContent.replace(/\s+/g," ").trim()));
  const header=["Tyrimas","ReikÅ¡mÄ—","Vienetai","Norma","Å½yma","Pastaba","Å altinis"];
  const data=[header,...rows];
  const csv=data.map(r=>r.map(v=>`"${v.replaceAll('"','""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tyrimai.csv"; a.click(); URL.revokeObjectURL(a.href);
});
clearBtn.addEventListener("click", ()=>{
  $("tbody").innerHTML=""; raw.textContent=""; coagTbody.innerHTML=""; coagWrap.classList.add("hidden");
  statusEl.textContent="IÅ¡valyta. Galite Ä¯kelti naujus failus.";
});
</script>
</body>
</html>
