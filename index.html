<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kraujo tyrimų analizė (beta)</title>
  <meta name="description" content="Įkelkite kraujo tyrimų nuotraukas arba PDF. OCR vykdomas naršyklėje.">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:,">
  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- PDF.js 3.11 (su worker) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  </script>
  <style>
    .dropzone { border: 2px dashed rgba(0,0,0,0.2); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased">
  <div class="max-w-5xl mx-auto p-4 sm:p-8">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-semibold">Kraujo tyrimų analizė (beta)</h1>
      <p class="text-sm text-gray-600 mt-2">
        Įkelkite laboratorinių tyrimų <b>nuotraukas arba PDF</b>. Viskas vyksta tik Jūsų įrenginyje.
      </p>
    </header>

    <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 text-sm rounded-lg p-3 mb-6">
      <b>Svarbu:</b> tai <u>ne</u> medicininė diagnozė ir <u>ne</u> gydymo rekomendacija. Rezultus interpretuoja gydytojas.
    </div>

    <section class="mb-6">
      <div id="drop" class="dropzone rounded-xl p-6 bg-white text-center cursor-pointer">
        <p class="text-sm text-gray-600">Nutempkite failus čia arba paspauskite, kad pasirinktumėte.</p>
        <p class="text-xs text-gray-400 mt-1">Leidžiami: JPG, PNG, WEBP, HEIC (jei palaikoma), PDF.</p>
        <input id="fileInput" type="file" accept="image/*,application/pdf" multiple class="hidden">
      </div>

      <div class="mt-4 flex items-center gap-3 flex-wrap">
        <button id="startBtn" class="px-4 py-2 rounded-lg bg-black text-white disabled:opacity-40">Analizuoti</button>
        <label class="text-sm flex items-center gap-2">
          <input id="debugMode" type="checkbox">
          <span>Debug režimas</span>
        </label>
        <span id="status" class="text-sm text-gray-600"></span>
      </div>

      <details class="mt-4">
        <summary class="text-sm font-medium cursor-pointer">Išplėstiniai nustatymai</summary>
        <div class="mt-3 space-y-2 text-sm">
          <label class="flex items-center gap-2">
            <input id="aggressive" type="checkbox">
            <span>Agresyvesnis lentelių/diag. išgavimas</span>
          </label>
        </div>
      </details>
    </section>

    <!-- Krešumo įspėjimas -->
    <section id="coagWrap" class="hidden mb-6">
      <div class="border border-red-200 bg-red-50 text-red-900 rounded-xl p-4">
        <h3 class="font-semibold">DĖMESIO: galimi nukrypimai kraujo krešumo tyrimuose</h3>
        <p class="text-sm mt-1">
          Kraujo tyrimas <b>neatitinka normų</b>. Rekomenduojame <b>pakartoti tyrimus po kelių dienų</b> ir, jei planuojama operacija,
          <b>susisiekti dėl galimo operacijos perkėlimo</b>.
        </p>
        <div class="overflow-x-auto bg-white rounded-lg border mt-3">
          <table class="min-w-full text-sm">
            <thead class="bg-red-100">
              <tr>
                <th class="text-left px-3 py-2">Tyrimas</th>
                <th class="text-left px-3 py-2">Reikšmė</th>
                <th class="text-left px-3 py-2">Vienetai</th>
                <th class="text-left px-3 py-2">Norma</th>
                <th class="text-left px-3 py-2">Žyma</th>
              </tr>
            </thead>
            <tbody id="coagTbody"></tbody>
          </table>
        </div>
        <p class="text-xs mt-2 opacity-80">Informacinis perspėjimas – nepakeičia gydytojo sprendimų.</p>
      </div>
    </section>

    <!-- Suvestinė -->
    <section id="results" class="hidden">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-xl font-semibold">Suvestinė</h2>
        <div class="flex gap-2">
          <button id="exportCsv" class="text-sm px-3 py-1.5 rounded border">Atsisiųsti CSV</button>
          <button id="clearBtn" class="text-sm px-3 py-1.5 rounded border">Išvalyti</button>
        </div>
      </div>

      <div class="overflow-x-auto bg-white rounded-xl border">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left px-3 py-2">Tyrimas</th>
              <th class="text-left px-3 py-2">Reikšmė</th>
              <th class="text-left px-3 py-2">Vienetai</th>
              <th class="text-left px-3 py-2">Norma (pagauta)</th>
              <th class="text-left px-3 py-2">Žyma</th>
              <th class="text-left px-3 py-2">Trumpa pastaba</th>
              <th class="text-left px-3 py-2">Šaltinis eilutėje</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <details class="mt-4" id="debugBox">
        <summary class="text-sm font-medium cursor-pointer">Debug informacija</summary>
        <div class="text-xs text-gray-700 mt-2 space-y-1 mono">
          <div id="dbgCounts"></div>
          <div id="dbgPreview" class="bg-gray-100 rounded p-2 overflow-x-auto"></div>
        </div>
      </details>

      <details class="mt-4">
        <summary class="text-sm font-medium cursor-pointer">Žalias atpažintas tekstas</summary>
        <pre id="raw" class="mono text-xs bg-gray-900 text-gray-100 rounded-lg p-3 overflow-x-auto"></pre>
      </details>

      <p class="text-xs text-gray-500 mt-3">
        Pirmumas – laboratorijos dokumente nurodytoms riboms. Jei jų nėra, taikomos atsargios „tipinės“ ribos (pažymimos).
      </p>
    </section>

    <footer class="mt-12 text-xs text-gray-400">
      © <span id="yr"></span>. Informacinis įrankis. Ne medicininė konsultacija.
    </footer>
  </div>

<script>
const $ = (id) => document.getElementById(id);
$("yr").textContent = new Date().getFullYear();

const DEC = (s) => { if (s==null) return null; const x=(""+s).replace(/\s/g,"").replace(",","."); const n=Number(x); return Number.isFinite(n)?n:null; };
const HL_RX    = /\b([HL])\b/;
const RANGE_RX = /(\d+(?:[.,]\d+)?)\s*[-–—]\s*(\d+(?:[.,]\d+)?)/;

// Vienetai + normalizacija
const UNIT_RX = /(g\/L|g\/dL|g%|mmol\/L|mg\/dL|µg\/L|ng\/mL|mIU\/L|µIU\/mL|pmol\/L|ng\/dL|x?10\^9\/L|10\^9\/L|x?10\^12\/L|10\^12\/L|10\^3\/u?L|10\^9\/u?L|\/µL|\/uL|\/µl|\/ul|\/mm3|\/cu\.mm|mg\/L|%|s|sec|sek|min|fL|fl|pg|L\/L)/i;
function normalizeUnits(u){
  if(!u) return u;
  u = u.replace(/\s+/g,"");
  if(/^g%$/i.test(u)) return "g/dL";
  if(/^\/cu\.mm$/i.test(u)) return "/mm3";
  if(/^\/u?l$/i.test(u)) return "/µL";
  if(/^10\^3\/u?l$/i.test(u)) return "10^3/µL";
  return u;
}

// Pastabos (trumpai)
const NOTES = {
  "Hemoglobinas": {low:"Dažna priežastis – geležies stoka ar kraujavimas.", high:"Galima dehidratacija; vertinti kliniką."},
  "CRP": {high:"Dažniausiai siejamas su uždegimu."},
  "INR": {high:"Padidėjęs INR – ilgesnis krešėjimo laikas.", low:"Mažas INR – trumpesnis krešėjimo laikas."},
  "aPTT": {high:"Prailgėjęs aPTT – lėtesnis krešėjimas.", low:"Sutrumpėjęs aPTT – greitesnis krešėjimas."},
  "Fibrinogenas": {low:"Žemas fibrinogenas gali mažinti krešumą.", high:"Didelis fibrinogenas – dažnai uždegimas."},
  "D-dimerai": {high:"Padidėjimas galimas įvairiose būklėse; vertinti kliniškai."}
};

// Sinonimai (bendri). Specifinius trumpinius parenkame atskirai (žiūr. detectByAbbrev).
const TEST_MAP = [
  {rx:/\b(PLT|Platelet(\s*Count)?|Platelets|trombocit(ai|ų)?)\b/i, name:"Trombocitai"},
  {rx:/\b((Total\s*)?WBC(\s*Count)?|White\s+Blood\s+Cell\s+Count|leukocyt(es?|e)?|leukocit(ai|ų)?)\b/i, name:"Leukocitai"},
  {rx:/\b(RBC(\s*Count)?|Red\s+Blood\s+Cell\s+Count|erythrocyt(es?|e)?|eritrocit(ai|ų)?)\b/i, name:"Eritrocitai"},
  {rx:/\bMCV\b|\bMean\s+Cell\s+Volume\b/i, name:"MCV"},
  {rx:/\bMCH\b|\bMean\s+Cell\s+Ha?emoglobin\b/i, name:"MCH"},
  {rx:/\bMCHC\b|\bMean\s+Cell\s+Ha?emoglobin\s+Concentration\b/i, name:"MCHC"},
  {rx:/\bRDW(-CV)?\b|\bRed\s+Cell\s+Distribution\s+Width\b/i, name:"RDW-CV"},
  {rx:/\bNEU[%#]?\b|\bNeutrophils?\b/i, name:"Neutrofilai"},
  {rx:/\bLYM[%#]?\b|\bLymphocytes?\b/i, name:"Limfocitai"},
  {rx:/\bMON[%#]?\b|\bMonocytes?\b/i, name:"Monocitai"},
  {rx:/\bEOS[%#]?\b|\bEosinophils?\b/i, name:"Eozinofilai"},
  {rx:/\bBAS[%#]?\b|\bBasophils?\b/i, name:"Bazofilai"},
  {rx:/\bHCT\b|\bha?ematocrit\b|\bPCV\b/i, name:"Hematokritas"},
  {rx:/\b(HGB|Hb|(?<!Mean\s+Cell\s)Ha?emoglobin)\b/i, name:"Hemoglobinas"}, // negaudo iš „Mean Cell …“
  {rx:/\b(glucose|gliukoz[ėe]|Glu)\b/i, name:"Gliukozė"},
  {rx:/\bCRP\b/i, name:"CRP"},
  // Krešumas
  {rx:/\bINR\b/i, name:"INR"},
  {rx:/\b(PT|protrombin(o)?\s*laik(as)?|Quick)\b/i, name:"Protrombino laikas (PT)"},
  {rx:/\bA?PTT\b|\baktyvuotas?\s+dalinis\s+tromboplastino\s+laikas\b/i, name:"aPTT"},
  {rx:/\bfibrinogen(as)?\b/i, name:"Fibrinogenas"},
  {rx:/\bD[\s-]?dimer(ai|ų)?\b/i, name:"D-dimerai"},
];

// Tipinės ribos
const TYPICAL = {
  "Hemoglobinas":   { units:["g/dL","g/L"], ranges:[{u:"g/dL", lo:12, hi:16},{u:"g/L", lo:120, hi:160}] },
  "Hematokritas":   { units:["%","L/L"], ranges:[{u:"%", lo:36, hi:46},{u:"L/L", lo:0.36, hi:0.46}] },
  "Eritrocitai":    { units:["x10^12/L","10^12/L"], ranges:[{u:"x10^12/L", lo:3.8, hi:5.2},{u:"10^12/L", lo:3.8, hi:5.2}] },
  "Leukocitai":     { units:["x10^9/L","10^9/L","/µL","/mm3","10^3/µL"], ranges:[
    {u:"x10^9/L", lo:4.0, hi:10.0},{u:"10^9/L", lo:4.0, hi:10.0},
    {u:"/µL", lo:4000, hi:11000},{u:"/mm3", lo:4000, hi:11000},
    {u:"10^3/µL", lo:4.0, hi:11.0}
  ]},
  "Trombocitai":    { units:["x10^9/L","10^9/L","/µL","/mm3","10^3/µL"], ranges:[
    {u:"x10^9/L", lo:150, hi:400},{u:"10^9/L", lo:150, hi:400},
    {u:"/µL", lo:150000, hi:450000},{u:"/mm3", lo:150000, hi:450000},
    {u:"10^3/µL", lo:150, hi:450}
  ]},
  "MCV":            { units:["fL","fl"], ranges:[{u:"fL", lo:83, hi:101},{u:"fl", lo:83, hi:101}] },
  "MCH":            { units:["pg"], ranges:[{u:"pg", lo:27, hi:32}] },
  "MCHC":           { units:["g/dL"], ranges:[{u:"g/dL", lo:32, hi:36}] },
  "RDW-CV":         { units:["%"], ranges:[{u:"%", lo:11.6, hi:14.0}] },
};

// UI / failai
const drop = $("drop"), input=$("fileInput"), startBtn=$("startBtn"), statusEl=$("status");
const results = $("results"), tbody=$("tbody"), raw=$("raw"), exportCsv=$("exportCsv"), clearBtn=$("clearBtn");
const coagWrap = $("coagWrap"), coagTbody = $("coagTbody");
const debugMode = $("debugMode"), dbgCounts=$("dbgCounts"), dbgPreview=$("dbgPreview"), debugBox=$("debugBox");
let files=[];
drop.addEventListener("click", () => input.click());
drop.addEventListener("dragover", (e)=>{e.preventDefault(); drop.classList.add("bg-gray-100");});
drop.addEventListener("dragleave", ()=>drop.classList.remove("bg-gray-100"));
drop.addEventListener("drop",(e)=>{ e.preventDefault(); drop.classList.remove("bg-gray-100");
  files=[...e.dataTransfer.files].filter(f=> f.type.startsWith("image/") || f.type==="application/pdf");
  statusEl.textContent=files.length?`Pasirinkta ${files.length} failas(-ai).`:"Nepasirinkta jokių failų.";
});
input.addEventListener("change",(e)=>{ files=[...e.target.files]; statusEl.textContent=files.length?`Pasirinkta ${files.length} failas(-ai).`:"Nepasirinkta jokių failų."; });

// --------- Normalizavimas (taškai, vienetai, tarpai) ----------
function normalizeLine(s){
  if(!s) return s;
  s = s.replace(/[\u00B7\u2219\u2022\u2027]/g, '.');         // · ∙ • ‧ -> .
  s = s.replace(/(\d)\s*[.,·∙•]\s*(\d)/g, '$1.$2');          // 30 . 5 -> 30.5
  s = s.replace(/10\*([0-9])\s*\/\s*[uµ]?[Ll]/gi, '10^$1/µL'); // 10*9/L -> 10^9/µL
  s = s.replace(/\/u[lL]/g, '/µL');                           // /uL -> /µL
  s = s.replace(/\bfl\b/g, 'fL');                             // fl -> fL
  s = s.replace(/\bl\/l\b/gi, 'L/L');                         // l/l -> L/L
  s = s.replace(/\s{2,}/g, ' ').trim();                       // sutraukti tarpus
  return s;
}

// Vaizdo pagerinimas (binarizacija)
async function fileToEnhancedBlob(file) {
  const img = await new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const im = new Image();
    im.onload = () => resolve(im);
    im.onerror = reject;
    im.src = url;
  });
  const maxW = 2200;
  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale), h = Math.round(img.height * scale);
  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
  const id = ctx.getImageData(0,0,w,h), d=id.data;
  let sum=0; for(let i=0;i<d.length;i+=4){ const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; sum+=g; }
  const avg=sum/(d.length/4), T=Math.max(110,Math.min(170,avg));
  for(let i=0;i<d.length;i+=4){ const g=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; const v=(g>T)?255:0; d[i]=d[i+1]=d[i+2]=v; d[i+3]=255; }
  ctx.putImageData(id,0,0);
  const blob = await new Promise(res => c.toBlob(res,"image/png",1));
  URL.revokeObjectURL(img.src); return blob;
}

// PDF -> PNG
async function pdfToImageBlobs(file, scale = 2.0) {
  const arrayBuf = await file.arrayBuffer();
  let pdf;
  try {
    pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
  } catch (e) {
    console.error("PDF open error:", e);
    throw new Error("Nepavyko atidaryti PDF (gal sugadintas failas?)");
  }
  const blobs = [];
  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width; canvas.height = viewport.height;
    const ctx = canvas.getContext("2d");
    await page.render({ canvasContext: ctx, viewport }).promise;
    const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1));
    blobs.push(blob);
  }
  return blobs;
}

// Grupavimas į eilutes
function groupWordsIntoLines(words){
  const good = words.filter(w => (w.conf ?? 0) >= 40 && w.text && w.text.trim());
  good.sort((a,b)=> a.y0 - b.y0 || a.x0 - b.x0);
  const lines = [], TOL = 10;
  for(const w of good){
    let line = lines.find(L => Math.abs(L.y - w.y0) < TOL);
    if(!line){ line = { y: w.y0, words: [] }; lines.push(line); }
    line.words.push(w);
  }
  for(const L of lines){ L.words.sort((a,b)=> a.x0 - b.x0); L.text = L.words.map(w=>w.text).join(" "); }
  return lines.map(L => L.text).filter(Boolean);
}
function groupWordsIntoLinesLoose(words){
  if (!words || !words.length) return [];
  const good = words.filter(w => (w.text||"").trim());
  good.sort((a,b)=> a.y0 - b.y0 || a.x0 - b.x0);
  const lines = [], TOL = 18;
  for(const w of good){
    let line = lines.find(L => Math.abs(L.y - w.y0) < TOL);
    if(!line){ line = { y: w.y0, words: [] }; lines.push(line); }
    line.words.push(w);
  }
  for(const L of lines){ L.words.sort((a,b)=> a.x0 - b.x0); L.text = L.words.map(w=>w.text).join(" "); }
  return lines.map(L => L.text).filter(s=>s.trim());
}

// Abbreviations pirmumas
function detectByAbbrev(s){
  const m = s.match(/\((WBC|RBC|PLT|MCV|MCHC?|HCT|Hb)\)/i);
  if(!m) return null;
  const tok = m[1].toUpperCase();
  const map = {WBC:"Leukocitai",RBC:"Eritrocitai",PLT:"Trombocitai",MCV:"MCV",MCH:"MCH",MCHC:"MCHC",HCT:"Hematokritas",HB:"Hemoglobinas"};
  return map[tok] || null;
}

// Pagrindinis veiksmas
startBtn.addEventListener("click", async () => {
  if (!files.length){ statusEl.textContent="Įkelkite bent vieną failą."; return; }
  startBtn.disabled=true;
  tbody.innerHTML=""; raw.textContent=""; coagTbody.innerHTML=""; coagWrap.classList.add("hidden");
  results.classList.remove("hidden"); statusEl.textContent="Vyksta OCR…";
  const aggressive=$("aggressive").checked;

  try{
    const worker = await Tesseract.createWorker("eng", 1, {});
    await worker.setParameters({
      tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.%/^-–—()µgdlpmnIUFLcu ",
      preserve_interword_spaces: "1",
      user_defined_dpi: "300",
      tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
      tessedit_do_invert: "1"
    });

    let allText = "", allWords = [], totalImages=0;

    for (let i = 0; i < files.length; i++) {
      statusEl.textContent = `OCR ${i+1}/${files.length}…`;
      const f = files[i];
      let blobs = [];
      if (f.type === "application/pdf") {
        const pageBlobs = await pdfToImageBlobs(f, 2.2);
        for (const b of pageBlobs) {
          const fakeFile = new File([b], "page.png", { type: "image/png" });
          blobs.push(await fileToEnhancedBlob(fakeFile));
        }
      } else {
        blobs.push(await fileToEnhancedBlob(f));
      }

      for (let j = 0; j < blobs.length; j++) {
        totalImages++;
        const label = blobs.length > 1 ? ` (psl. ${j+1})` : "";
        const { data } = await worker.recognize(blobs[j]);
        allText += `\n\n===== FAILAS ${i+1}${label} =====\n` + data.text;
        allWords = allWords.concat(data.words.map(w => ({
          text: w.text, x0:w.bbox.x0, y0:w.bbox.y0, x1:w.bbox.x1, y1:w.bbox.y1, conf:w.conf
        })));
      }
    }
    await worker.terminate();

    raw.textContent = allText.trim();
    statusEl.textContent="Analizuoju tekstą…";

    // 1) bbox griežtas
    let lines = groupWordsIntoLines(allWords).map(normalizeLine);

    // 2) bbox laisvas, jei mažai
    if (!lines || lines.length < 5) {
      lines = groupWordsIntoLinesLoose(allWords).map(normalizeLine);
    }

    // 3) jei vis dar trūksta – raw text eilutės
    if (!lines || lines.length < 3) {
      const naiveLines = raw.textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      lines = naiveLines.map(normalizeLine);
    }

    // Debug
    if (debugMode.checked) {
      debugBox.open = true;
      dbgCounts.innerHTML = `Žodžiai: <b>${allWords.length}</b> • Eilutės: <b>${lines.length}</b> • Paveikslai: <b>${totalImages}</b>`;
      const prev = lines.slice(0,30).map((s,i)=>`${i+1}. ${s}`).join("\n");
      dbgPreview.textContent = prev || "(tuščia)";
    } else debugBox.open = false;

    // Analizė (1) – stulpeliais su dviejų eilučių sujungimu
    let rows = analyzeByColumns(lines);

    // Jei mažai – senasis parseris, tada grubus fallback
    if (rows.length < 4) {
      rows = analyzeText(lines.join("\n"), { aggressive });
      if (!rows.length) rows = bruteExtract(raw.textContent);
    }

    renderRows(rows);
    renderCoagAlert(rows);
    statusEl.textContent = rows.length ? `Rasta įrašų: ${rows.length}` : "Nepavyko aptikti lentelės. Pabandykite aiškesnę nuotrauką/PDF arba priartinkite tik lentelę.";
  }catch(err){
    console.error(err);
    const msg = (err && err.message) ? err.message : String(err);
    statusEl.textContent="Įvyko klaida apdorojant: " + msg;
  }finally{
    startBtn.disabled=false;
  }
});

// Grubus fallback
function bruteExtract(text){
  const out=[];
  const lines=text.split(/\r?\n/).map(s=>normalizeLine(s)).filter(Boolean);
  for(const ln of lines){
    const name = detectByAbbrev(ln) || (TEST_MAP.find(m=>m.rx.test(ln))||{}).name;
    if(!name) continue;
    const mVal = ln.match(/(-?\d+(?:[.,]\d+)?)/);
    if(!mVal) continue;
    const val = DEC(mVal[1]);
    const um = ln.match(UNIT_RX);
    out.push({name, value:val, units:normalizeUnits(um?um[1]:""), range:"", lo:null, hi:null, tag:"Neaišku", note:"", typicalFallback:false, source:ln});
  }
  return out;
}

// --- Stulpelinė analizė su 2 eilučių sujungimu + trumpinių prioritetu ---
function analyzeByColumns(lines){
  const rows = [];
  // rasti antraštę (nebūtina)
  let start = lines.findIndex(s => /\bTEST\b/i.test(s) && /\bRESULT\b/i.test(s));
  if (start < 0) start = 0;

  for (let i = start + 1; i < lines.length; i++){
    let s = normalizeLine(lines[i]);
    if (!s || /^[-\s]*$/.test(s) || /end of report/i.test(s)) continue;

    // jei eilutėje nėra skaičiaus, bet panašu į pavadinimą – sujunk su kita eilute
    const looksLikeName = /[A-Za-z]/.test(s) && !/-?\d+(?:[.,]\d+)?/.test(s);
    if (looksLikeName && i+1 < lines.length){
      const next = normalizeLine(lines[i+1]);
      if (/-?\d+(?:[.,]\d+)?/.test(next)) { s = `${s}  ${next}`; i++; }
    }

    const parts = s.split(/\s{2,}/).map(t => t.trim()).filter(Boolean);
    if (parts.length < 2) continue;

    // Pavadinimas – pagal trumpinį skliaustuose arba sinonimų žemėlapį
    const nameRaw = parts[0];
    const abbrevName = detectByAbbrev(nameRaw) || detectByAbbrev(s);
    const hitName = abbrevName || (TEST_MAP.find(m=>m.rx.test(nameRaw))||{}).name;
    if (!hitName) continue;

    // Reikšmė: pirmas skaičius po pavadinimo; jei ne – parts[1]
    let tail = s.replace(nameRaw, "");
    let mVal = tail.match(/-?\d+(?:[.,]\d+)?/);
    if (!mVal && parts[1]) mVal = parts[1].match(/-?\d+(?:[.,]\d+)?/);
    const value = mVal ? DEC(mVal[0]) : null;

    // Ribos
    let lo = null, hi = null, range = "";
    let r = s.match(RANGE_RX) || (parts[2] && parts[2].match && parts[2].match(RANGE_RX));
    if (r){ lo = DEC(r[1]); hi = DEC(r[2]); range = `${r[1]}–${r[2]}`; }

    // Vienetai
    let units = "";
    const um = (parts[3] || parts[2] || parts[1] || s).match(UNIT_RX);
    if (um) units = normalizeUnits(um[1]);

    // Tipinės ribos, jei laboratorija nepateikė
    if ((lo==null || hi==null) && hitName in TYPICAL){
      const t=TYPICAL[hitName];
      if (units && t.ranges) {
        const rr=t.ranges.find(x=>x.u.toLowerCase()===(units||"").toLowerCase());
        if(rr){ lo=rr.lo; hi=rr.hi; if(!range) range=`${rr.lo}–${rr.hi}`; }
      }
    }

    let tag = "Neaišku";
    if (value!=null && lo!=null && hi!=null) tag = value<lo ? "Žemas" : (value>hi ? "Aukštas" : "Normoje");

    rows.push({
      name: hitName, value, units: units||"", range, lo, hi, tag,
      note: (NOTES[hitName] && (tag==="Aukštas"?NOTES[hitName].high:NOTES[hitName].low)) || "",
      typicalFallback: false, source: s
    });
  }
  return rows;
}

// Eilučių parseris (papildomas)
function analyzeText(text,{aggressive=false}={}){
  const lines = text.split(/\r?\n/).map(s=>normalizeLine(s)).filter(Boolean);
  const results=[], windowSize=2;
  for(let i=0;i<lines.length;i++){
    const line=lines[i];
    const name = detectByAbbrev(line) || (TEST_MAP.find(m=>m.rx.test(line))||{}).name;
    if(!name){ if(!aggressive) continue; if(!/[A-Za-zĄČĘĖĮŠŲŪąčęėįšųū]/.test(line)) continue; }

    let value=null, units=null, flag=null;
    const hl=line.match(HL_RX); if(hl) flag=hl[1].toUpperCase()==="H"?"H":"L";

    let m = line.match(/(-?\d+(?:[.,]\d+)?)/);
    if (m) value = DEC(m[1]);
    if (value==null) {
      for (let k=1; k<=2 && i+k<lines.length; k++){
        const cand = lines[i+k];
        const mm = cand.match(/(-?\d+(?:[.,]\d+)?)/);
        if (mm) { value = DEC(mm[1]); const um2 = cand.match(UNIT_RX); if (um2) units = normalizeUnits(um2[1]); break; }
      }
    }

    const um=line.match(UNIT_RX); if(um) units=normalizeUnits(um[1]);

    let lo=null, hi=null, rangeText=null, r=line.match(RANGE_RX);
    if(!r){
      for(let k=1;k<=windowSize && i+k<lines.length;k++){ r=lines[i+k].match(RANGE_RX); if(r) break; }
      if(!r){ for(let k=1;k<=windowSize && i-k>=0;k++){ r=lines[i-k].match(RANGE_RX); if(r) break; } }
    }
    if(r){ lo=DEC(r[1]); hi=DEC(r[2]); rangeText=`${r[1]}–${r[2]}`; }

    let usedTypical=false;
    if((lo==null || hi==null) && name in TYPICAL){
      const t=TYPICAL[name];
      if(units && t.ranges){
        const rr=t.ranges.find(x=>x.u.toLowerCase()===(units||"").toLowerCase());
        if(rr){ lo=rr.lo; hi=rr.hi; usedTypical=true; rangeText=`${rr.lo}–${rr.hi}`; }
      }
    }

    let tag="";
    if(value!=null && lo!=null && hi!=null){ tag = value<lo ? "Žemas" : (value>hi ? "Aukštas" : "Normoje"); }
    else if(flag){ tag = flag==="H" ? "Aukštas" : "Žemas"; }
    else { tag="Neaišku"; }

    let note=""; if(name in NOTES){ if(tag==="Aukštas" && NOTES[name].high) note=NOTES[name].high; if(tag==="Žemas" && NOTES[name].low) note=NOTES[name].low; }
    if(!name || (!value && !aggressive)) continue;

    results.push({name, value, units:units||"", range:rangeText||"", lo, hi, tag, note, typicalFallback:usedTypical, source:line});
  }

  const merged=new Map();
  for(const r of results){
    const key=r.name+"|"+(r.units||"");
    if(!merged.has(key)) merged.set(key,r);
    else{
      const score=x=> (x.lo!=null && x.hi!=null ? 2:0) + (x.value!=null?1:0);
      merged.set(key, score(r)>=score(merged.get(key)) ? r : merged.get(key));
    }
  }
  return [...merged.values()];
}

// Render / perspėjimas
function renderRows(rows){
  tbody.innerHTML="";
  for(const r of rows){
    const color = r.tag==="Aukštas"?"bg-red-50 text-red-700" : r.tag==="Žemas"?"bg-yellow-50 text-yellow-700" : r.tag==="Normoje"?"bg-green-50 text-green-700":"bg-gray-50 text-gray-700";
    const tr=document.createElement("tr");
    const tip = r.typicalFallback ? ' <span class="text-xs text-gray-500">(tipinės ribos)</span>' : '';
    tr.innerHTML=`
      <td class="px-3 py-2">${escapeHtml(r.name)}</td>
      <td class="px-3 py-2">${r.value!=null ? r.value : ""}</td>
      <td class="px-3 py-2">${escapeHtml(r.units||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.range||"")}${tip}</td>
      <td class="px-3 py-2"><span class="px-2 py-1 rounded ${color}">${r.tag}</span></td>
      <td class="px-3 py-2">${escapeHtml(r.note||"")}</td>
      <td class="px-3 py-2 text-xs text-gray-500">${escapeHtml(r.source)}</td>
    `;
    tbody.appendChild(tr);
  }
}
function isCoagTest(name){ return ["INR","Protrombino laikas (PT)","aPTT","Fibrinogenas","D-dimerai"].includes(name); }
function renderCoagAlert(rows){
  const bad = rows.filter(r => isCoagTest(r.name) && (r.tag==="Aukštas" || r.tag==="Žemas"));
  if(!bad.length){ coagWrap.classList.add("hidden"); return; }
  coagTbody.innerHTML="";
  for(const r of bad){
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="px-3 py-2">${escapeHtml(r.name)}</td>
      <td class="px-3 py-2">${r.value!=null ? r.value : ""}</td>
      <td class="px-3 py-2">${escapeHtml(r.units||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.range||"")}</td>
      <td class="px-3 py-2">${escapeHtml(r.tag)}</td>
    `;
    coagTbody.appendChild(tr);
  }
  coagWrap.classList.remove("hidden");
}
function escapeHtml(s){ return (s==null?"":String(s)).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }

// CSV / valymas
exportCsv.addEventListener("click", ()=>{
  const rows=[...tbody.querySelectorAll("tr")].map(tr=>[...tr.children].map(td=>td.textContent.replace(/\s+/g," ").trim()));
  const header=["Tyrimas","Reikšmė","Vienetai","Norma","Žyma","Pastaba","Šaltinis"];
  const data=[header,...rows];
  const csv=data.map(r=>r.map(v=>`"${v.replaceAll('"','""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="tyrimai.csv"; a.click(); URL.revokeObjectURL(a.href);
});
clearBtn.addEventListener("click", ()=>{ tbody.innerHTML=""; raw.textContent=""; coagTbody.innerHTML=""; coagWrap.classList.add("hidden"); statusEl.textContent="Išvalyta. Galite įkelti naujus failus."; });
</script>
</body>
</html>
